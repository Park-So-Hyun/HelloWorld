<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Code">
	<insert id="insert" parameterType="kh.hello.dto.CodeQuestionDTO">
		insert into codeQuestion
		values(codeQuestionSeq.nextval,#{division},#{title},#{content},#{id},#{writer},#{point},0,sysdate)
	</insert>
	<select id="selectQuestionAll" resultType="kh.hello.dto.CodeQuestionDTO">
		select codeQuestion.*,(select count(*) from codeReply where queSeq=codeQuestion.seq) as replyCount from (select codeQuestion.*, row_number() over(order by seq desc) rown from codeQuestion) codeQuestion where rown between #{start} and #{end} order by seq desc
	</select>
	
<!-- 	<select id="selectAll" resultType="kh.hello.dto.CodeQuestionDTO"> -->
<!-- 		select codeQuestion.*,(select count(*) from codeReply where queSeq=codeQuestion.seq) as replyCount from codeQuestion order by seq desc -->
<!-- 	</select> -->
	
<!-- 	<select id="selectQuestionAll" resultType="kh.hello.dto.CodeQuestionDTO"> -->
<!-- 		select * from (select codeQuestion.*, row_number() over(order by seq desc) rown from codeQuestion) where rown between 1 and 10 -->
<!-- 	</select> -->
	
	<select id="codeQuestionCount" resultType="Integer">
  		select count(*) from codeQuestion
  	</select>
  	
	<select id="selectSeq" parameterType="String" resultType="Integer">
		select max(seq) from codeQuestion where writer = #{writer}
	</select>
	
	<select id="detailQuestion" resultType="kh.hello.dto.CodeQuestionDTO">
		select * from codeQuestion where seq = #{seq} order by 1 desc
	</select>
	
	<update id="incrementViewCount" parameterType="Integer">
		update codeQuestion set viewCount = viewCount+1 where seq = #{seq}
	</update>
	
	<delete id="delete" parameterType="Integer">
		delete from codeQuestion where seq=#{seq}
	</delete>
	
	<update id="modify" parameterType="kh.hello.dto.CodeQuestionDTO">
		update codeQuestion set division=#{division},title=#{title},content=#{content},point=#{point} where seq=#{seq}
	</update>
	
	<update id="writePoint" parameterType="String">
		update member set point=point+10 where id=#{id}
	</update>
	
	<update id="deleteWritePoint" parameterType="String">
		update member set point=point-15 where id=#{id}
	</update>
	
	<!-- 조건별 게시판목록 검색 -->
	<select id="codeSearchTotalCount" parameterType="java.util.Map" resultType="integer">
		 select count(seq) from codeQuestion
		 <choose>
		 <when test="value == 'all'">								
			 where (division like '%${search}%') or (writer like '%${search}%') or (title like '%${search}%') 
		</when>
		<when test="value == 'division'">								
			 where (division like '%${search}%')
		</when>
		<when test="value == 'title'">								
			 where (title like '%${search}%')
		</when>
		<when test="value == 'writer'">								
			 where (writer like '%${search}%')
		</when>
		</choose>
	</select>
	
	<select id="codeSearchByPage" resultType="kh.hello.dto.CodeQuestionDTO" parameterType="java.util.Map">
		select * 
		<choose>
		 <when test="value == 'all'">								
			 from (select codeQuestion.*, row_number() over (order by seq desc) as rown from codeQuestion where (division like '%${search}%') or (writer like '%${search}%') or (title like '%${search}%')) where rown between #{start} and #{end}
			 
		</when>
		<when test="value == 'division'">
			 from (select codeQuestion.*, row_number() over (order by seq desc) as rown from codeQuestion where (division like '%${search}%')) where rown between #{start} and #{end}						
		</when>
		<when test="value == 'writer'">
			 from (select codeQuestion.*, row_number() over (order by seq desc) as rown from codeQuestion where (writer like '%${search}%')) where rown between #{start} and #{end}						
		</when>
		<when test="value == 'title'">								
			 from (select codeQuestion.*, row_number() over (order by seq desc) as rown from codeQuestion where (title like '%${search}%')) where rown between #{start} and #{end}
		</when>
		</choose>
	</select>
	
	<!-- 	이미지 업로드 -->
	<select id="getCodeSeq" resultType="integer">
		select codeQuestionSeq.nextval from dual
	</select>
	<insert id="insertImg" parameterType="java.util.Map">
		insert into codeImgs values(codeImgsSeq.nextVal, #{queSeq}, #{fileName})
	</insert>
	
<!-- 	스크랩 -->
	<select id="scrapDupCheck" parameterType="kh.hello.dto.ScrapDTO" resultType="integer">
		select count(*) from scrap where id=#{id} and category=#{category} and categorySeq=#{categorySeq}
	</select>
	
	<select id="earlierSeq" resultType="integer">
		select scrapSeq.nextval from dual
	</select>
	
	<insert id="scrapCode">
		insert into scrap values(#{seq}, #{id}, #{category}, #{categorySeq})
	</insert>
</mapper>